# Next.js Parallel Routes 進階模式

**版本:** Next.js 15+  
**描述:** Next.js 平行路由的進階使用模式、複雜場景和最佳實踐  
**分類:** Advanced Patterns  
**複雜度:** Advanced  
**用途:** 進階架構、複雜場景、性能優化  
**最後更新:** 2025-01-17

## 攔截路由模式

使用攔截路由實現複雜的導航行為

### 同級攔截
- **描述:** 使用 (.) 攔截同級路由
- **約定:** `(.)folder`
- **用途:** 攔截同一級別的路由，用於顯示模態框而不改變 URL
- **範例:** `app/@modal/(.)photo/page.tsx` 攔截 `app/photo/page.tsx`

### 上一級攔截
- **描述:** 使用 (..) 攔截上一級路由
- **約定:** `(..)folder`
- **用途:** 攔截上一級的路由，即使文件系統層級不同
- **範例:** `app/feed/@modal/(..)photo/page.tsx` 攔截 `app/photo/page.tsx`

### 多級上攔截
- **描述:** 使用 (..)(..) 攔截多級上路由
- **約定:** `(..)(..)folder`
- **用途:** 攔截兩級以上的路由
- **範例:** `app/feed/@modal/(..)(..)photo/page.tsx` 攔截 `app/photo/page.tsx`

### 根級攔截
- **描述:** 使用 (...) 攔截根級路由
- **約定:** `(...)folder`
- **用途:** 攔截從根 app 目錄開始的路由
- **範例:** `app/feed/@modal/(...)photo/page.tsx` 攔截 `app/photo/page.tsx`

## 條件渲染模式

根據不同條件動態渲染平行路由槽位

### 用戶角色條件渲染
- **描述:** 根據用戶權限渲染不同的槽位內容
- **實現:** 在佈局組件中檢查用戶角色，返回對應的槽位內容
- **使用場景:** 管理員儀表板、用戶權限控制、多租戶應用

### 功能標誌條件渲染
- **描述:** 根據功能標誌控制槽位的顯示
- **實現:** 使用環境變數或配置控制槽位的渲染
- **使用場景:** A/B 測試、功能發布控制、實驗性功能

### 設備類型條件渲染
- **描述:** 根據設備類型渲染不同的槽位
- **實現:** 使用客戶端檢測或服務器端檢測
- **使用場景:** 響應式設計、移動端優化、桌面端增強

## 狀態管理模式

管理平行路由槽位之間的狀態共享和同步

### 共享狀態槽位
- **描述:** 多個槽位共享相同的狀態
- **實現:** 使用 React Context、Zustand 或 Redux
- **使用場景:** 購物車狀態、用戶偏好設置、應用主題

### 槽位間通信
- **描述:** 不同槽位之間的數據傳遞
- **實現:** 使用事件系統、狀態提升或共享存儲
- **使用場景:** 表單驗證、數據同步、用戶操作反饋

### 異步狀態同步
- **描述:** 處理槽位間的異步數據同步
- **實現:** 使用 SWR、React Query 或自定義 hooks
- **使用場景:** 實時數據更新、緩存同步、離線同步

## 性能優化模式

優化平行路由的性能和用戶體驗

### 懶加載槽位
- **描述:** 按需加載槽位內容
- **實現:** 使用 React.lazy 和 Suspense
- **使用場景:** 大型應用、複雜儀表板、按需功能

### 預取策略
- **描述:** 智能預取槽位內容
- **實現:** 使用 Next.js Link prefetch 或自定義預取邏輯
- **使用場景:** 用戶行為預測、關鍵路徑優化、緩存策略

### 虛擬化渲染
- **描述:** 處理大量數據的槽位
- **實現:** 使用 react-window 或 react-virtualized
- **使用場景:** 數據表格、長列表、複雜圖表

## 錯誤邊界模式

處理平行路由中的錯誤和異常情況

### 槽位級錯誤邊界
- **描述:** 為每個槽位設置獨立的錯誤邊界
- **實現:** 使用 React Error Boundary 組件
- **使用場景:** 隔離錯誤、優雅降級、用戶體驗保護

### 降級渲染
- **描述:** 當槽位出錯時提供備用內容
- **實現:** 使用 try-catch 或錯誤邊界的 fallback
- **使用場景:** 服務不可用、數據加載失敗、組件崩潰

### 錯誤恢復
- **描述:** 自動恢復出錯的槽位
- **實現:** 使用重試機制或狀態重置
- **使用場景:** 網絡錯誤、臨時故障、用戶操作錯誤

## 無障礙訪問模式

確保平行路由的可訪問性和用戶體驗

### 焦點管理
- **描述:** 管理多個槽位之間的焦點導航
- **實現:** 使用 React useRef 和 focus 管理
- **使用場景:** 鍵盤導航、屏幕閱讀器、焦點陷阱

### ARIA 標籤
- **描述:** 為槽位提供適當的 ARIA 標籤
- **實現:** 使用 role、aria-label 等屬性
- **使用場景:** 語義化標籤、屏幕閱讀器支持、無障礙導航

### 鍵盤快捷鍵
- **描述:** 提供鍵盤快捷鍵操作槽位
- **實現:** 使用 useEffect 和事件監聽器
- **使用場景:** 快速導航、無障礙操作、效率提升

## 測試模式

測試平行路由的各種場景和邊界情況

### 單元測試
- **描述:** 測試個別槽位組件的功能
- **實現:** 使用 Jest 和 React Testing Library
- **使用場景:** 組件邏輯、Props 驗證、事件處理

### 集成測試
- **描述:** 測試槽位之間的交互
- **實現:** 使用 Cypress 或 Playwright
- **使用場景:** 槽位通信、狀態同步、用戶流程

### 端到端測試
- **描述:** 測試完整的用戶場景
- **實現:** 使用 E2E 測試框架
- **使用場景:** 真實用戶體驗、跨槽位導航、錯誤處理
