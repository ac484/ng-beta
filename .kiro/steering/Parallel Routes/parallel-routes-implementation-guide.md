# Next.js Parallel Routes 實作指南

**版本:** Next.js 15+  
**描述:** Next.js 平行路由的完整實作指南，包含步驟說明、最佳實踐和常見陷阱  
**分類:** Implementation Guide  
**複雜度:** Intermediate  
**用途:** 實作指南、開發流程、最佳實踐  
**最後更新:** 2025-01-17

## 設置指南

從零開始設置平行路由的完整流程

### 步驟 1: 創建槽位目錄
- **描述:** 使用 `@` 符號創建命名槽位
- **範例:** `app/@analytics/`
- **注意:** 槽位名稱不能包含特殊字符，建議使用描述性名稱

### 步驟 2: 創建佈局組件
- **描述:** 在父級目錄創建 `layout.tsx` 文件
- **範例:** `app/(dashboard)/layout.tsx`
- **注意:** 佈局組件必須接受所有槽位作為 props

### 步驟 3: 定義槽位 Props
- **描述:** 在佈局組件中定義槽位的 TypeScript 類型
- **範例:**
```tsx
interface LayoutProps { 
  children: React.ReactNode; 
  analytics: React.ReactNode; 
  team: React.ReactNode; 
}
```
- **注意:** 使用 `React.ReactNode` 類型確保類型安全

### 步驟 4: 渲染槽位
- **描述:** 在佈局組件中渲染所有槽位
- **範例:**
```tsx
return ( 
  <div> 
    {children} 
    <div className="analytics">{analytics}</div> 
    <div className="team">{team}</div> 
  </div> 
)
```
- **注意:** 確保所有槽位都被正確渲染

## 文件結構指南

平行路由的標準文件結構和命名約定

### 應用目錄結構
```
app/
  (dashboard)/              # 分組路由，不影響 URL 結構
    layout.tsx
    page.tsx
  @analytics/               # 分析模組槽位
    page.tsx
    loading.tsx
    error.tsx
    default.tsx
  @team/                    # 團隊模組槽位
    page.tsx
    loading.tsx
    error.tsx
    default.tsx
```

### 命名約定
- 使用 `@` 符號前綴定義槽位
- 槽位名稱使用小寫字母和連字符
- 避免使用特殊字符和空格
- 使用描述性的名稱表示槽位功能

## 組件實作

平行路由組件的實作細節和最佳實踐

### 佈局組件
**描述:** 主要的佈局組件，負責渲染所有槽位

**實作要點:**
- **Props:** 接受所有槽位作為 props
- **渲染:** 條件性或無條件渲染槽位
- **樣式:** 為每個槽位提供適當的樣式和佈局
- **錯誤處理:** 處理槽位渲染錯誤

**最佳實踐:**
- 使用 TypeScript 確保類型安全
- 提供適當的默認值
- 實現錯誤邊界
- 優化渲染性能

### 槽位組件
**描述:** 每個槽位的具體內容組件

**實作要點:**
- **內容:** 實現槽位的具體功能
- **載入:** 提供載入狀態
- **錯誤:** 處理錯誤情況
- **默認:** 提供默認內容

**最佳實踐:**
- 保持組件職責單一
- 實現適當的錯誤處理
- 提供載入狀態
- 優化組件性能

## 路由行為

平行路由的路由行為和導航特性

### 客戶端導航
- **描述:** 使用 Link 組件或 useRouter 進行導航
- **行為:** 部分渲染，保持其他槽位狀態
- **實作:** 使用 Next.js 的 Link 組件或 useRouter hook

### 服務器端導航
- **描述:** 直接訪問 URL 或頁面刷新
- **行為:** 完整渲染，無法確定未匹配槽位的狀態
- **實作:** 使用 `default.tsx` 處理未匹配的槽位

### 攔截路由
- **描述:** 使用特殊文件夾名稱攔截路由
- **行為:** 顯示模態框而不改變 URL
- **實作:** 使用 `(.)`、`(..)`、`(..)(..)`、`(...)` 約定

## 狀態管理

管理平行路由中的狀態和數據流

### 共享狀態
- **描述:** 多個槽位共享相同的狀態
- **實作:** 使用 React Context、Zustand 或 Redux
- **使用場景:** 用戶認證、應用主題、全局設置

### 獨立狀態
- **描述:** 每個槽位維護自己的狀態
- **實作:** 使用 `useState` 或 `useReducer`
- **使用場景:** 表單數據、UI 狀態、本地偏好

### 同步狀態
- **描述:** 槽位間狀態的同步和通信
- **實作:** 使用事件系統或狀態提升
- **使用場景:** 數據更新、用戶操作、實時同步

## 錯誤處理

處理平行路由中的錯誤和異常情況

### 錯誤邊界
- **描述:** 使用 React Error Boundary 捕獲錯誤
- **實作:** 為每個槽位設置獨立的錯誤邊界
- **好處:** 錯誤隔離、優雅降級、用戶體驗保護

### 錯誤頁面
- **描述:** 為每個槽位提供錯誤頁面
- **實作:** 創建 `error.tsx` 文件
- **好處:** 用戶友好、錯誤信息、恢復選項

### 默認內容
- **描述:** 提供默認內容作為備用
- **實作:** 創建 `default.tsx` 文件
- **好處:** 內容可用性、用戶體驗、功能降級

## 性能優化

優化平行路由的性能和用戶體驗

### 代碼分割
- **描述:** 按需加載槽位內容
- **實作:** 使用 `React.lazy` 和 `Suspense`
- **好處:** 減少初始包大小、按需加載、更好的性能

### 預取策略
- **描述:** 智能預取槽位內容
- **實作:** 使用 Next.js Link prefetch
- **好處:** 更快的導航、更好的用戶體驗、減少等待時間

### 緩存策略
- **描述:** 實現適當的緩存策略
- **實作:** 使用 SWR 或 React Query
- **好處:** 減少重複請求、更快的響應、離線支持

## 測試策略

測試平行路由的各種場景和邊界情況

### 單元測試
- **描述:** 測試個別組件的功能
- **工具:** Jest, React Testing Library
- **重點:** 組件邏輯、Props 驗證、事件處理

### 集成測試
- **描述:** 測試槽位之間的交互
- **工具:** Cypress, Playwright
- **重點:** 槽位通信、狀態同步、用戶流程

### 端到端測試
- **描述:** 測試完整的用戶場景
- **工具:** E2E 測試框架
- **重點:** 真實用戶體驗、跨槽位導航、錯誤處理

## 常見陷阱

實作平行路由時常見的問題和解決方案

### 忘記創建 default.tsx
- **問題:** 未匹配的槽位會顯示 404 錯誤
- **解決方案:** 為每個槽位創建 `default.tsx` 文件
- **預防:** 在設置槽位時立即創建默認文件

### 槽位 Props 類型錯誤
- **問題:** TypeScript 編譯錯誤或運行時錯誤
- **解決方案:** 正確定義所有槽位的 Props 類型
- **預防:** 使用嚴格的 TypeScript 配置

### 狀態管理複雜性
- **問題:** 槽位間狀態同步變得複雜
- **解決方案:** 使用適當的狀態管理解決方案
- **預防:** 在設計階段規劃狀態架構

### 性能問題
- **問題:** 所有槽位同時渲染導致性能問題
- **解決方案:** 實現懶加載和條件渲染
- **預防:** 在早期階段考慮性能影響
